<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solicitudes</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

<header class="navbar">
  <div class="navbar-inner">
    <div class="brand">
      <img src="{{ url_for('static', filename='img/logo-a3.png') }}" alt="Logo A3">
      <div class="brand-title">
        <strong>A3 Laboratorio Veterinario</strong>
        <span>Solicitud de recogida de muestras</span>
      </div>
    </div>

    <nav class="nav">
      <a class="nav-btn {{ 'active' if active=='form' else '' }}" href="{{ url_for('home') }}">Nueva solicitud</a>
      <a class="nav-btn {{ 'active' if active=='solicitudes' else '' }}" href="{{ url_for('ver_solicitudes') }}">Ver solicitudes</a>
      <a class="nav-btn" href="{{ url_for('logout') }}">Logout</a>
    </nav>
  </div>
</header>

<main class="container">
  <h1>Solicitudes (últimas 50)</h1>

  <!-- Toolbar -->
  <div class="table-toolbar">
    <label class="check-all">
      <input type="checkbox" id="checkAll">
      <span>Seleccionar todo</span>
    </label>

    <button class="btn-danger" id="btnDelete" type="button" disabled>
      Borrar seleccionadas
    </button>

    <div class="selected-count">
      <span id="countSelected">0</span> seleccionadas
    </div>
  </div>

  <!-- Tabla -->
  <div class="table-wrap">
    <table class="data-table">
      <thead>
        <tr>
          <th class="col-check"></th>
          <th>ID</th>
          <th>Dueño</th>
          <th>Tel</th>
          <th>Vivienda</th>
          <th>Dirección</th>
          <th>Horario</th>
          <th>Fecha</th>
          <th>Mascota</th>
          <th>Especie</th>
          <th>Raza</th>
          <th>Edad</th>
          <th>Muestra</th>
          <th>¿Cuál?</th>
          <th>Condición</th>
          <th>Estado</th>
          <th>Creado</th>
        </tr>
      </thead>

      <tbody>
        {% for s in solicitudes %}
        <tr>
          <td class="col-check">
            <input class="row-check" type="checkbox" value="{{ s.id }}">
          </td>

          <td class="mono">{{ s.id }}</td>
          <td>{{ s.dueno or '' }}</td>
          <td class="mono">{{ s.tel or '' }}</td>
          <td>{{ s.vivienda or '' }}</td>
          <td class="cell-wrap">{{ s.direccion or '' }}</td>
          <td>{{ s.horario or '' }}</td>
          <td class="mono">{{ s.fecha or '' }}</td>
          <td>{{ s.mascota or '' }}</td>
          <td>{{ s.especie or '' }}</td>
          <td>{{ s.raza or '' }}</td>
          <td class="mono">{{ s.edad or '' }}</td>
          <td>{{ s.muestra or '' }}</td>
          <td class="cell-wrap">{{ s.muestra_cual or '' }}</td>
          <td class="cell-wrap">{{ s.condicion or '' }}</td>

          <td>
            <span class="badge">{{ s.estado or '' }}</span>
          </td>

          <td class="mono">{{ s.creado or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Form oculto para borrar -->
  <form id="deleteForm" method="POST" action="{{ url_for('borrar_solicitudes') }}" style="display:none;">
    <input type="hidden" name="ids" id="idsToDelete" value="">
  </form>
</main>

<script>
  const checkAll = document.getElementById("checkAll");
  const rowChecks = () => Array.from(document.querySelectorAll(".row-check"));
  const btnDelete = document.getElementById("btnDelete");
  const countSelected = document.getElementById("countSelected");
  const deleteForm = document.getElementById("deleteForm");
  const idsToDelete = document.getElementById("idsToDelete");

  function updateUI(){
    const selected = rowChecks().filter(c => c.checked);
    countSelected.textContent = String(selected.length);
    btnDelete.disabled = selected.length === 0;
    checkAll.checked = selected.length > 0 && selected.length === rowChecks().length;
    checkAll.indeterminate = selected.length > 0 && selected.length < rowChecks().length;
  }

  checkAll.addEventListener("change", () => {
    rowChecks().forEach(c => c.checked = checkAll.checked);
    updateUI();
  });

  document.addEventListener("change", (e) => {
    if (e.target.classList && e.target.classList.contains("row-check")) {
      updateUI();
    }
  });

  btnDelete.addEventListener("click", () => {
    const selectedIds = rowChecks().filter(c => c.checked).map(c => c.value);
    if (selectedIds.length === 0) return;

    const ok = confirm(`¿Borrar ${selectedIds.length} solicitud(es)?`);
    if (!ok) return;

    idsToDelete.value = selectedIds.join(",");
    deleteForm.submit();
  });

  updateUI();
</script>

</body>
</html>
